# Gremlin Telegram Bot

Телеграм-бот для групповых чатов, который реагирует на упоминания, умеет «вклиниваться» в диалог и поддерживает несколько ярких персон (стилей общения). Всё работает на Python, FastAPI и aiogram, с хранением данных в PostgreSQL и кэшем в Redis.

## Что умеет бот
- работает и через polling, и через вебхуки;
- запоминает историю чатов и использует её как контекст для ответов;
- поддерживает пять базовых персон (standup, gopnik, boss, zoomer, jarvis) и любые ваши собственные;
- позволяет оперативно менять поведение прямо в чате через `/settings` и централизованно в веб-панели;
- включает веб-панель администратора с Bootstrap-интерфейсом: чаты, глобальные настройки, история, персоны;
- экспортирует health-check и метрики для наблюдения.

## Быстрый старт
1. Скопируйте `.env.example` в `.env` и заполните минимум:
   ```
   BOT_TOKEN=123456:ABC...
   USE_POLLING=1            # для локального запуска
   ADMIN_TOKEN=supersecret
   ```
   Для вебхуков добавьте `PUBLIC_BASE_URL=https://bot.example.com` и `TELEGRAM_SECRET_TOKEN=...`.

2. Запустите контейнеры:
   ```bash
   docker compose up --build
   ```
   Проверьте `http://localhost:8080/health` и `http://localhost:8080/metrics`.

3. Нужен hot reload? Используйте дев-конфиг:
   ```bash
   docker compose -f docker-compose.dev.yml up --build
   ```
   Код будет примонтирован, `uvicorn` перезапускается автоматически.

При старте каждый контейнер прогоняет `alembic upgrade head`, так что таблицы всегда актуальные.

## Основные переменные окружения
- `BOT_TOKEN` — токен Telegram бота.
- `USE_POLLING` — `1` для long-polling, `0` для вебхуков.
- `PUBLIC_BASE_URL` — внешний адрес (только для вебхука).
- `TELEGRAM_SECRET_TOKEN` — секрет, Telegram добавляет его в заголовок `X-Telegram-Bot-Api-Secret-Token`.
- `DATABASE_URL` — строка подключения к Postgres (по умолчанию указывает на сервис `db`).
- `REDIS_URL` — адрес Redis (`redis://redis:6379/0`).
- `OLLAMA_URL`/`OLLAMA_MODEL` или `OPENROUTER_*` — настройки LLM по вашему выбору.
- `PORT` — порт приложения внутри контейнера (по умолчанию `8080`).
- `INTERJECT_TICK_SECONDS` — как часто проверять «спящие» чаты.
- `ADMIN_TOKEN` — токен доступа к админ-панели.

Все переменные уже описаны в `.env.example`; в `docker-compose.yml` они прокидываются через `${...}` и легко настраиваются в Portainer.

## Команды в чате
- `/bot on|off|status` — включить/выключить бота в чате и посмотреть текущие параметры.
- `/trigger mode <mention|reply|all>` — настроить, когда бот отвечает автоматически.
- `/interject p <0-100>` / `/interject cooldown <сек>` — задать шанс «влезания» и кулдаун (глобально для всех чатов).
- `/quiet <HH:MM-HH:MM|off>` — задать тихие часы для текущего чата.
- `/style <persona>` — выбрать активную персону (учитываются базовые и кастомные).
- `/length <символы>` — ограничить длину ответа (глобально).
- `/context max_turns <N>` или `/context max_tokens <N>` — настроить глубину контекста (глобально).
- `/settings` — открыть интерактивное меню с кнопками (активация, стиль, тихие часы, оживление).
- `/roll` — запустить рулетку в чате и выбрать обладателя звания дня.
- `/summary` — получить пересказ последних сообщений в стиле активной персоны.
- `/rollstats_montly` — показать статистику победителей за текущий месяц.
- `/rollstats_total` — показать статистику победителей за всё время.
- `/rolltitle <текст>` — задать своё прозвище для рулетки (можно также через `/settings`).
- `/reg` — зарегистрироваться в рулетке, чтобы участвовать в розыгрышах.
- `/unreg` — выйти из участия в рулетке.

## Админ-панель
- Вход: `http://localhost:8080/admin/chats?token=<ADMIN_TOKEN>`
- «Чаты»: стиль, тихие часы, «оживление», просмотр истории.
- «Настройки»: глобальные параметры — контекст, длина ответа, окно токенов, вероятность и кулдаун вмешательств.
- «Персоны»: редактирование базовых промтов, добавление/удаление собственных образов.
- «Сообщения»: разовая рассылка от имени бота в выбранные или все чаты.

## Вебхук или polling
- **Polling** (`USE_POLLING=1`) — удобно для локальной разработки: бот сам опрашивает Telegram, внешний URL не нужен.
- **Webhook** (`USE_POLLING=0` + `PUBLIC_BASE_URL`) — Telegram присылает запросы сам. Нужен доступный снаружи HTTPS-домен. При старте бота webhook выставляется автоматически.

## Разработка и миграции
- Создать новую миграцию: `alembic revision -m "add something" --autogenerate`
- Применить вручную: `alembic upgrade head` или `./scripts/migrate.sh`
- Откатиться: `alembic downgrade -1`

База хранится в volume `db_data`. Если нужно начать с чистого листа, остановите compose и удалите volume (`docker volume rm gremlin_bot_db_data`).
